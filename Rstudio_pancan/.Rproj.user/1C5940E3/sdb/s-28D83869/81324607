{
    "collab_server" : "",
    "contents" : "library(OIsurv)\nlibrary(cgdsr)\nlibrary(cluster)\nlibrary(fpc)\nlibrary(gplots)\nlibrary(heatmap.plus)\nlibrary(reshape)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(plotrix)\n\nresults <- read.csv(\"/Users/Eric/tcrseq/new/processed/pancan_exome_rna_blood_tcrb_gsva_clinical_7-13-2016.txt\", sep=\"\\t\")\nclonotypes <- read.csv(\"/Users/Eric/tcrseq/new/processed/pancan_clonotypes_all_7-14-2016.txt\", sep=\"\\t\")\n\n### recreate figures from BRCA paper\n\ncdr3_results_current<-results\n\n# calculating the iDNA score, rna_rpm, R and D groups\ncdr3_results_current<-mutate(cdr3_results_current,exome_rpm=exome_cdr3*10^6/exome_reads)\ntmp<-select(filter(cdr3_results_current,exome_rpm!=0),patient_uuid,exome_rpm)\ntmp<-mutate(tmp,iDNA_score=ntile(exome_rpm,10))\ncdr3_results_current<-left_join(cdr3_results_current,tmp)\ncdr3_results_current<-mutate(cdr3_results_current,iDNA_score=ifelse(is.na(iDNA_score),0,iDNA_score))\n\ncdr3_results_current<-mutate(cdr3_results_current,rna_rpm=rna_cdr3*10^6/rna_reads)\ncdr3_results_current<-mutate(cdr3_results_current,blood_rpm=blood_cdr3*10^6/blood_reads)\ncdr3_results_current<-mutate(cdr3_results_current,D=ifelse(exome_rpm==0,\"D-\",\"D+\"),R=ifelse(rna_rpm==0,\"R-\",\"R+\"))\n\n### recreate relevant results report\ncancer_current <- cdr3_results_current\n# remove cohort size <400\n# BLCA, BRCA, COAD, HNSC, KIRC, LGG, LUAD, LUSC, OV, PRAD, STAD, THCA, UCEC\ncancer_current <- filter(cdr3_results_current, cohort==\"BLCA\" | cohort==\"BRCA\" | cohort==\"COAD\" | cohort==\"HNSC\" |\n                       cohort==\"KIRC\" | cohort==\"LGG\" | cohort==\"LUAD\" | cohort==\"LUSC\" | cohort==\"OV\" |\n                       cohort==\"PRAD\" | cohort==\"STAD\" | cohort==\"THCA\" | cohort==\"UCEC\")\ncancer_current$cohort <- factor(cancer_current$cohort)\ncancer_split <- split(cancer_current, cancer_current$cohort)\n\n# contrast infiltration of cancer types\nexome_split <- lapply(cancer_split, '[[', \"exome_rpm\")\nrna_split <- lapply(cancer_split, '[[', \"rna_rpm\")\nblood_split <- lapply(cancer_split, '[[', \"blood_rpm\")\nidna_split <- lapply(cancer_split, '[[', \"iDNA_score\")\n\nggplot(cancer_current, aes(x=exome_rpm, y=rna_rpm, colour=cohort)) + geom_point()\n\nexome_avg <- sapply(exome_split, mean, na.rm=TRUE)\nrna_avg <- sapply(rna_split, mean, na.rm=TRUE)\ncohort_sizes <- table(cancer_current$cohort)\navgs_plot <- as.data.frame(cbind(exome_avg, rna_avg, cohort_sizes))\n\nggplot(avgs_plot, aes(exome_avg, rna_avg, size=cohort_sizes, colour=rownames(avgs_plot))) + geom_point()\n\n# exome CDR3 high without RNA\ntmp <- filter(cancer_current,D==\"D+\",R==\"R-\")\n\n# exome vs. blood\nexome_only <- filter(clonotypes, exome > 0)\n\n# rna vs. dna\n\n# gsva\ncancer_heatmap <- cancer_current[!is.na(cancer_current$T.regs),]\n\nsignatures <- select(cancer_heatmap, cohort, T.regs:Neut)\ncohorts <- signatures[,1]\nsignatures <- signatures[,-1]\n\nsignature_cols <- c(\"T Regs\", \"T CD8\", \"T CD4 Naive\", \"T CD4 Mem. Resting\", \"T CD4 Mem. Activated\",\n                    \"T Folicular Helper\", \"T Gamma Delta\", \"B Naive\", \"B Memory\", \"Plasma\", \"NK Resting\",\n                    \"NK Activated\", \"Monocytes\", \"Macrophages M0\", \"Macrophages M1\", \"Macrophages M2\",\n                    \"Dendritic Resting\", \"Dendritic Activated\", \"Mast Resting\", \"Mast Activated\",\n                    \"Eosinophils\", \"Neutrophils\")\n\n# colors still not working, need to copy work form \"brca_final_paper.R\")\ncohort_colors <- color.scale(as.numeric(cohorts), color.spec=\"bluerange\")\ngsva_colors <- color.scale(as.numeric(cancer_heatmap$gsva_cluster), color.spec=\"bluerange\")\ncohort_colors <- matrix(c(cohort_colors, cohort_colors), ncol=2, byrow=FALSE)\n\nheatmap.plus(as.matrix(signatures), col=bluered(51), scale=\"none\", Colv=NA, labRow=\"\",\n             labCol=signature_cols, RowSideColors=cohort_colors)\n\n#heatmap.plus(as.matrix(signatures), col=bluered(51), scale=\"none\", Colv=NA, labRow=\"\",\n#             labCol=signature_cols, cexCol=2, margins=c(22,6))\n\n# clonal diversity\n\n\n# survival\n\n\n\n### OLD \n# figure FracRNA pos vs DNA\nfrac_withRNA<-aggregate(rna_rpm~iDNA_score,data=filter(cdr3_results_current,!is.na(rna_rpm)),FUN=function(x) length(x[x>0.0255])/length(x))\nggplot(frac_withRNA,aes(factor(reorder(iDNA_score,as.numeric(iDNA_score))),rna_rpm))+geom_bar(stat=\"identity\")+theme(text=element_text(size=32))+xlab(\"iDNA score\")+ylab(\"Fraction of tumors \\n with high RNA CDR3 RPM\")+theme_classic(base_size = 24)\n\n#figure FracTIL vs DNA\nfrac_withTILs<-aggregate(percent_tils~iDNA_score,data=cdr3_results_current,FUN=function(x) length(x[x>=5])/length(x))\nggplot(frac_withTILs,aes(factor(reorder(iDNA_score,as.numeric(iDNA_score))),percent_tils))+geom_bar(stat=\"identity\")+theme(text=element_text(size=32))+xlab(\"iDNA score\")+ylab(\"Fraction of tumors with â‰¥5% TILs\")+theme_classic(base_size = 24)\n\n# distribution by clinical groups\nggplot(cdr3_results_current,aes(as.factor(iDNA_score),fill=cohort))+geom_bar(position=\"fill\")+theme_classic(base_size = 24)+ylab(\"Fraction of tumors\")+xlab(\"iDNA score\")+theme(legend.title=element_blank())\n\n# survival\n\n",
    "created" : 1467848972109.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "571916246",
    "id" : "81324607",
    "lastKnownWriteTime" : 1469048225,
    "last_content_update" : 1469048225593,
    "path" : "~/tcrseq/new/rstudio/data_analysis2.R",
    "project_path" : "data_analysis2.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}