{
    "collab_server" : "",
    "contents" : "library(OIsurv)\nlibrary(cgdsr)\nlibrary(cluster)\nlibrary(fpc)\nlibrary(gplots)\nlibrary(heatmap.plus)\nlibrary(reshape2)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(plotrix)\nlibrary(VennDiagram)\nlibrary(ggrepel)\n\nresults <- read.csv(\"/Users/Eric/tcrseq/new/final/pancan_results_8-10-2016.txt\", sep=\"\\t\")\nclonotypes <- read.csv(\"/Users/Eric/tcrseq/new/final/pancan_clonotypes_8-10-2016.txt\", sep=\"\\t\")\n\ncdr3_results_current <- results\ncancer_current <- cdr3_results_current\n\nexome_rpm_med <- median(filter(cdr3_results_current, exome_level>0)$exome_rpm)\ncdr3_results_current<-mutate(cdr3_results_current,exome_lowhigh=ifelse(exome_rpm>exome_rpm_med,\"1\",\"0\"))\n\ntil_med <- median(cdr3_results_current$percent_tils, na.rm=TRUE)\ncdr3_results_current<-mutate(cdr3_results_current,til_lowhigh=ifelse(percent_tils>til_med,\"1\",\"0\"))\n\ncdr3_results_current<-mutate(cdr3_results_current,gsva_lowhigh=ifelse(gsva_cluster==1 | gsva_cluster==4,\"1\",\"0\"))\n\n# remove cohort size <400\n# BLCA, BRCA, COAD, HNSC, KIRC, LGG, LUAD, LUSC, OV, PRAD, STAD, THCA, UCEC\n#cancer_current <- filter(cdr3_results_current, cohort==\"BLCA\" | cohort==\"BRCA\" | cohort==\"COAD\" | cohort==\"HNSC\" |\n#                       cohort==\"KIRC\" | cohort==\"LGG\" | cohort==\"LUAD\" | cohort==\"LUSC\" | cohort==\"OV\" |\n#                       cohort==\"PRAD\" | cohort==\"STAD\" | cohort==\"THCA\" | cohort==\"UCEC\")\n#cancer_current$cohort <- factor(cancer_current$cohort)\n#cancer_split <- split(cancer_current, cancer_current$cohort)\n\n# remove THYM since it only has ONE exome case, UVM and CHOL have no RNA\ncancer_current <- filter(cdr3_results_current, cohort != \"THYM\", cohort != \"UVM\", cohort != \"CHOL\")\ncancer_current$cohort <- factor(cancer_current$cohort)\ncancer_split <- split(cancer_current, cancer_current$cohort)\n\n# survival\nsurv_results_p <- function(surv_matrix)\n{\n  p_val_out <- rep(NA, 5)\n  # exome nonzero\n  surv <- surv_matrix[,c(\"exome_level\", \"days_compound\", \"vital_status\")]\n  surv$days_compound <- surv_matrix$days_compound/365\n  my.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\n  my.fit <- survfit(my.surv ~ surv[,1])\n  if (nrow(my.fit)>1) {p_val_out[1] <- summary(coxph(my.surv ~ surv[,1], method=\"breslow\"))$logtest[3]}\n\n  # RNA low/high\n  surv <- surv_matrix[,c(\"RNA_level\", \"days_compound\", \"vital_status\")]\n  surv$days_compound <- surv_matrix$days_compound/365\n  my.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\n  my.fit <- survfit(my.surv ~ surv[,1])\n  if (nrow(my.fit)>1) {p_val_out[2] <- summary(coxph(my.surv ~ surv[,1], method=\"breslow\"))$logtest[3]}\n  \n  # exome low/high\n  surv <- surv_matrix[,c(\"exome_lowhigh\", \"days_compound\", \"vital_status\")]\n  surv$days_compound <- surv_matrix$days_compound/365\n  my.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\n  my.fit <- survfit(my.surv ~ surv[,1])\n  if (nrow(my.fit)>1) {p_val_out[3] <- summary(coxph(my.surv ~ surv[,1], method=\"breslow\"))$logtest[3]}\n  \n  # TIL low/high\n  surv <- surv_matrix[,c(\"til_lowhigh\", \"days_compound\", \"vital_status\")]\n  surv$days_compound <- surv_matrix$days_compound/365\n  my.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\n  my.fit <- survfit(my.surv ~ surv[,1])\n  if (nrow(my.fit)>1) {p_val_out[4] <- summary(coxph(my.surv ~ surv[,1], method=\"breslow\"))$logtest[3]}\n  \n  # GSVA low/high\n  surv <- surv_matrix[,c(\"gsva_lowhigh\", \"days_compound\", \"vital_status\")]\n  surv$days_compound <- surv_matrix$days_compound/365\n  my.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\n  my.fit <- survfit(my.surv ~ surv[,1])\n  if (nrow(my.fit)>1) {p_val_out[5] <- summary(coxph(my.surv ~ surv[,1], method=\"breslow\"))$logtest[3]}\n  \n  return(p_val_out)\n}\n\ntypes <- split(cancer_current, cancer_current$cohort)\n#types_surv_exome <- lapply(types, surv_results_exome)\n#types_surv_RNA <- lapply(types, surv_results_RNA)\ntypes_surv_p <- sapply(types, surv_results_p)\nrownames(types_surv_p) <- c(\"exome zero/nonzero\", \"rna low/high\", \"exome low/high\",\n                            \"TILs low/high\", \"GSVA low/high\")\n\nwrite.table(types_surv_p, \"survival_pvals.txt\", quote=FALSE, sep=\"\\t\")\n\n### FIGURE: COAD survival by exome CDR3 RPM ###\npdf(\"coad_exome_cdr3_survival.pdf\", width=8, height=8)\nmar.default <- c(5.1, 4.1, 4.1, 2.1)\noma.default <- c(0,0,0,0)\npar(mar = mar.default + c(1,1,0,0))\npar(oma = oma.default + c(0,1,0,0))\nsurv_matrix <- types$COAD\nsurv <- surv_matrix[,c(\"exome_level\", \"days_compound\", \"vital_status\")]\nsurv$days_compound <- surv_matrix$days_compound/365\nmy.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\nmy.fit <- survfit(my.surv ~ surv[,1])\nplot(my.fit, col=c(1,2), xlab=\"Survival Time (years)\", ylab=\"Survival Probability\", \n     cex.axis=1.75, cex.lab=2.25, cex.main=1.75, lwd=4, cex=2)\nlegend(x=\"bottomright\", c(\"Zero\", \"Nonzero\"), fill=c(1,2), cex=2, bty=\"n\")\nsurvdiff(my.surv ~ surv[,1])\ntext(x=9.5, y=0.95, labels=\"p=0.0006\", cex=2)\ndev.off()\ncox.fit <- coxph(my.surv ~ surv[,1])\nsummary(cox.fit)\n\n### FIGURE: CESC survival by RNA CDR3 RPM ###\npdf(\"cesc_rna_cdr3_survival.pdf\", width=8, height=8)\nmar.default <- c(5.1, 4.1, 4.1, 2.1)\noma.default <- c(0,0,0,0)\npar(mar = mar.default + c(1,1,0,0))\npar(oma = oma.default + c(0,1,0,0))\nsurv_matrix <- types$CESC\nsurv <- surv_matrix[,c(\"RNA_level\", \"days_compound\", \"vital_status\")]\nsurv$days_compound <- surv_matrix$days_compound/365\nmy.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\nmy.fit <- survfit(my.surv ~ surv[,1])\nplot(my.fit, col=c(1,2), xlab=\"Survival Time (years)\", ylab=\"Survival Probability\", \n     cex.axis=1.75, cex.lab=2.25, cex.main=1.75, lwd=4, cex=2)\nlegend(x=\"bottomright\", c(\"Low\", \"High\"), fill=c(1,2), cex=2, bty=\"n\")\nsurvdiff(my.surv ~ surv[,1])\ntext(x=9.5, y=0.95, labels=\"p=0.004\", cex=2)\ndev.off()\ncox.fit <- coxph(my.surv ~ surv[,1])\nsummary(cox.fit)\n\n### FIGURE: BRCA survival by GSVA low/high ###\npdf(\"brca_gsva_lowhigh_survival.pdf\", width=8, height=8)\nmar.default <- c(5.1, 4.1, 4.1, 2.1)\noma.default <- c(0,0,0,0)\npar(mar = mar.default + c(1,1,0,0))\npar(oma = oma.default + c(0,1,0,0))\nsurv_matrix <- types$BRCA\nsurv <- surv_matrix[,c(\"gsva_lowhigh\", \"days_compound\", \"vital_status\")]\nsurv$days_compound <- surv_matrix$days_compound/365\nmy.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\nmy.fit <- survfit(my.surv ~ surv[,1])\nplot(my.fit, col=c(1,2), xlab=\"Survival Time (years)\", ylab=\"Survival Probability\", \n     cex.axis=1.75, cex.lab=2.25, cex.main=1.75, lwd=4, cex=2)\nlegend(x=\"bottomright\", c(\"Low\", \"High\"), fill=c(1,2), cex=2, bty=\"n\")\nsurvdiff(my.surv ~ surv[,1])\ntext(x=9.5, y=0.95, labels=\"p=0.04\", cex=2)\ntext(x=5, y=0.2, labels=\"n=72/32 low/high\", cex=2)\ndev.off()\ncox.fit <- coxph(my.surv ~ surv[,1])\nsummary(cox.fit)\n\n### FIGURE: HNSC survival by GSVA low/high ###\npdf(\"hnsc_gsva_lowhigh_survival.pdf\", width=8, height=8)\nmar.default <- c(5.1, 4.1, 4.1, 2.1)\noma.default <- c(0,0,0,0)\npar(mar = mar.default + c(1,1,0,0))\npar(oma = oma.default + c(0,1,0,0))\nsurv_matrix <- types$HNSC\nsurv <- surv_matrix[,c(\"gsva_lowhigh\", \"days_compound\", \"vital_status\")]\nsurv$days_compound <- surv_matrix$days_compound/365\nmy.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\nmy.fit <- survfit(my.surv ~ surv[,1])\nplot(my.fit, col=c(1,2), xlab=\"Survival Time (years)\", ylab=\"Survival Probability\", \n     cex.axis=1.75, cex.lab=2.25, cex.main=1.75, lwd=4, cex=2)\nlegend(x=\"topright\", c(\"Low\", \"High\"), fill=c(1,2), cex=2, bty=\"n\")\nsurvdiff(my.surv ~ surv[,1])\ntext(x=9.5, y=0.95, labels=\"p=0.04\", cex=2)\ntext(x=5, y=0.1, labels=\"n=103/64 low/high\", cex=2)\ndev.off()\ncox.fit <- coxph(my.surv ~ surv[,1])\nsummary(cox.fit)\n\n\n### FIGURE: CESC survival by GSVA low/high ###\npdf(\"cesc_gsva_lowhigh_survival.pdf\", width=8, height=8)\nmar.default <- c(5.1, 4.1, 4.1, 2.1)\noma.default <- c(0,0,0,0)\npar(mar = mar.default + c(1,1,0,0))\npar(oma = oma.default + c(0,1,0,0))\nsurv_matrix <- types$CESC\nsurv <- surv_matrix[,c(\"gsva_lowhigh\", \"days_compound\", \"vital_status\")]\nsurv$days_compound <- surv_matrix$days_compound/365\nmy.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\nmy.fit <- survfit(my.surv ~ surv[,1])\nplot(my.fit, col=c(1,2), xlab=\"Survival Time (years)\", ylab=\"Survival Probability\", \n     cex.axis=1.75, cex.lab=2.25, cex.main=1.75, lwd=4, cex=2)\nlegend(x=\"topright\", c(\"Low\", \"High\"), fill=c(1,2), cex=2, bty=\"n\")\nsurvdiff(my.surv ~ surv[,1])\ntext(x=9.5, y=0.95, labels=\"p=0.02\", cex=2)\ntext(x=5, y=0.1, labels=\"n=40/20 low/high\", cex=2)\ndev.off()\ncox.fit <- coxph(my.surv ~ surv[,1])\nsummary(cox.fit)\n\n\n### FIGURE: LGG survival by GSVA low/high ###\npdf(\"lgg_gsva_lowhigh_survival.pdf\", width=8, height=8)\nmar.default <- c(5.1, 4.1, 4.1, 2.1)\noma.default <- c(0,0,0,0)\npar(mar = mar.default + c(1,1,0,0))\npar(oma = oma.default + c(0,1,0,0))\nsurv_matrix <- types$LGG\nsurv <- surv_matrix[,c(\"gsva_lowhigh\", \"days_compound\", \"vital_status\")]\nsurv$days_compound <- surv_matrix$days_compound/365\nmy.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\nmy.fit <- survfit(my.surv ~ surv[,1])\nplot(my.fit, col=c(1,2), xlab=\"Survival Time (years)\", ylab=\"Survival Probability\", \n     cex.axis=1.75, cex.lab=2.25, cex.main=1.75, lwd=4, cex=2)\nlegend(x=\"topright\", c(\"Low\", \"High\"), fill=c(1,2), cex=2, bty=\"n\")\nsurvdiff(my.surv ~ surv[,1])\ntext(x=9.5, y=0.95, labels=\"p=0.01\", cex=2)\ntext(x=5, y=0.1, labels=\"n=58/34 low/high\", cex=2)\ndev.off()\ncox.fit <- coxph(my.surv ~ surv[,1])\nsummary(cox.fit)\n\n### FIGURE: LIHC survival by GSVA low/high ###\npdf(\"lihc_gsva_lowhigh_survival.pdf\", width=8, height=8)\nmar.default <- c(5.1, 4.1, 4.1, 2.1)\noma.default <- c(0,0,0,0)\npar(mar = mar.default + c(1,1,0,0))\npar(oma = oma.default + c(0,1,0,0))\nsurv_matrix <- types$LIHC\nsurv <- surv_matrix[,c(\"gsva_lowhigh\", \"days_compound\", \"vital_status\")]\nsurv$days_compound <- surv_matrix$days_compound/365\nmy.surv <- Surv(as.numeric(surv[,2]), as.numeric(surv[,3]))\nmy.fit <- survfit(my.surv ~ surv[,1])\nplot(my.fit, col=c(1,2), xlab=\"Survival Time (years)\", ylab=\"Survival Probability\", \n     cex.axis=1.75, cex.lab=2.25, cex.main=1.75, lwd=4, cex=2)\nlegend(x=\"topright\", c(\"Low\", \"High\"), fill=c(1,2), cex=2, bty=\"n\")\nsurvdiff(my.surv ~ surv[,1])\ntext(x=9.5, y=0.95, labels=\"p=0.01\", cex=2)\ntext(x=5, y=0.1, labels=\"n=65/24 low/high\", cex=2)\ndev.off()\ncox.fit <- coxph(my.surv ~ surv[,1])\nsummary(cox.fit)",
    "created" : 1470937758478.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "329465642",
    "id" : "FEA73450",
    "lastKnownWriteTime" : 1471468516,
    "last_content_update" : 1471468516939,
    "path" : "~/tcrseq/new/rstudio_plots/survival_analysis.R",
    "project_path" : "survival_analysis.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}